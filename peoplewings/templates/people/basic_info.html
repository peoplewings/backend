{% extends "people/base_people.html" %}
{% block content_title %}
<div class="subnav span12">
    <ul class="nav nav-pills">
      <li class="active"><a href="#">Basic info</a></li>
	  <li><a href="../location">Location</a></li>
      <li><a href="../about">About me</a></li>
      <li><a href="../likes">Likes</a></li>
      <li><a href="../contact">Contact info</a></li>
      <li><a href="../travels">Travels</a></li>
    </ul>
  </div>
{% endblock %}
{% load static from staticfiles %}
{% block content %}

<div>
    <div class="entry">
        <form id="my-form" method="post" action="" class="well form-horizontal span8">
            {% csrf_token %}
			{{ formset.management_form }}
			{% for form in formset %}

					{% include "general/custom_fieldset.html" %}
            
	        {% endfor %}
			{{ langset.management_form }}
			{% for form in langset %}

					{% include "general/custom_fieldset.html" with errors=langset.non_form_errors %}
            
	        {% endfor %}
		<div class="form-actions">
			<button type="reset" class="btn" style="margin-left: 160px">Cancel</button>
			<button type="submit" class="btn btn-primary" style="margin-left: 160px">Submit</button>
		</div>
        </form>
		<ul class="thumbnails">
            <li class="span4">
              <a href="#" class="thumbnail" style="width:246px; height: 284px">
                <img id="avatar" src="/{{avatar}}" onerror='this.onerror = null; this.src="{% static "img/blank_avatar.jpg" %}"' alt="">
			    <div class="progress progress-striped"  style="margin-top:10px;display:none;">
  					<div class="bar" style="width: 0%;"></div>
			  	</div>
              </a>
            </li>
            <li>
				<form id="file-form" method="post" action="" enctype="multipart/form-data">
				<input class="span4" type="file" id="upload" name="files[]" />
				<!--<output id="list"></output>-->
				</form>
			</li>
          </ul>
    </div>
</div>
<!-- Button to trigger modal 
<a href="#myModal" role="button" class="btn" data-toggle="modal" data-target="#myModal">Launch demo modal</a>-->
 
<div class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none; width:840px; margin: -340px 0 0 -400px;">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Crop image</h3>
  </div>
  <div class="modal-body" style="max-height: 500px">
    <p>Crop the image you uploaded for your avatar</p>
   
	<center style="margin: 10px 0">
	<img id="cropbox" style="margin: 0 30px" src="" alt="">
	</center>
<form id="coords" class="coords" onsubmit="return false;" style="display: block">

      <div>
      <label>X1 <input type="text" size="4" id="id_x" name="x1"></label>
      <label>Y1 <input type="text" size="4" id="id_y" name="y1"></label>
      <label>W <input type="text" size="4" id="id_w" name="w"></label>
      <label>H <input type="text" size="4" id="id_h" name="h"></label>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button id="cancel-crop" class="btn" data-dismiss="modal" aria-hidden="true">Dismiss</button>
    <button id="submit-avatar" class="btn btn-primary">Crop it</button>
  </div>
</div>

<div class="modal" id="errors-modal" tabindex="-1" role="dialog" aria-labelledby="errorsModalLabel" aria-hidden="true" style="display: none">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Something went wrong...</h3>
  </div>
  <div class="modal-body">
	<ul style="list-decoration:none">
	</ul>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>

{% endblock %}

{% block page_scripting %}
	<script type="text/javascript">
           $(function() {
               $('#my-form > fieldset[id^=lang]').formset({'prefix': '{{ langset.prefix }}'});

			   $('#upload').css("visibility", "hidden");
			   $('a.thumbnail').click(function(e){
   					e.preventDefault();
    				$('#upload').trigger('click');  
				});
		
				if (window.File && window.FileReader && window.FileList && window.Blob) {
  					function handleFileSelect(evt) {
    					var files = evt.target.files; // FileList object
						console.dir(files)
					    // files is a FileList of File objects. List some properties.
					    //var output = [];
					    /*
						   Protect uploading big files
						if (files[0].size > 500000){
							alert('Maximum image size allowed is 0.5 Mb')
							return
						} 
						*/
					    /*
						Shows a list of files selected
						for (var i = 0, f; f = files[i]; i++) {
					      output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
					                  f.size, ' bytes, last modified: ',
					                  f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
					                  '</li>');
					    }
					    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
						*/
						if (files.length > 0) uploadFile(files[0])
					  }
					  document.getElementById('upload').addEventListener('change', handleFileSelect, false);
				} else {
  					alert('The File APIs are not fully supported in this browser.');
				}
				function uploadFile(file) {
					
	       			var fd = new FormData();
				    fd.append("image", file);
				    fd.append("owner", "{{ profile_id }}");
				    var xhr = new XMLHttpRequest();
				    xhr.upload.addEventListener("progress", uploadProgress, false);
				    xhr.addEventListener("load", uploadComplete, false);
				    xhr.addEventListener("error", uploadFailed, false);
				    xhr.addEventListener("abort", uploadCanceled, false);
				    xhr.open("POST", "/cropper/");
					xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
					$('.progress').show()
				    xhr.send(fd);
			    }
				function uploadProgress(evt) {
			        if (evt.lengthComputable) {
			          var percentComplete = Math.round(evt.loaded * 100 / evt.total);
			
			          $('.progress > .bar').attr( { "style": "width:" + percentComplete.toString() + "%" });
			        }
			        else {
			          document.getElementById('progressNumber').innerHTML = 'unable to compute';
			        }
			      }
			      function uploadComplete(evt) {
			        /* This event is raised when the server send back a response */
			         //$(document).innerHTML = evt.target.responseText
			        var data = $.parseJSON(evt.target.response)
					if (data.success){
						console.log(data)
						$('.progress').hide()
						$('.modal-body img').attr("src", "/media/{{ profile_id }}/" + data.data.image)
						console.log("WxH: " + data.data.width + "x" + data.data.height)
						
						$('#cropbox').Jcrop({
	        				onChange:   showCoords,
					        onSelect:   showCoords,
					        onRelease:  clearCoords,
							aspectRatio: 8 / 10,
							setSelect:   [ 50, 50, 296, 334],
							minSize: [123, 142],
							//boxWidth: 600, 
							//boxHeight: 400
					    });

						$('#myModal').modal('show')
						/*$('#cancel-crop').click(function(evt){
							//alert('An image was uploaded, saved to disk, but dismissed... FIX IT!!')
							deleteImage(data.data.id)
							
						})*/
						$('#myModal').on('hide', function(evt){
							//alert('An image was uploaded, saved to disk, but dismissed... FIX IT!!')
							console.log('Hide..............')
							deleteImage(data.data.id)
							
						})
						
						
						
						
						$('#submit-avatar').click(function(evt){
						
						//console.log('Jcrop resized to...' + $('div.jcrop-holder img').width() + "x" + $('div.jcrop-holder img').height())
						//var real_w = data.data.width;
						//var resized_w = $('div.jcrop-holder img').width()
						//var scale = real_w / resized_w
						//console.log("Scale factor is: " + scale)
						var scale = 1;
						var fd = new FormData();
					    fd.append("x", $('#id_x').val()*scale);
						fd.append("y", $('#id_y').val()*scale);
						fd.append("w", $('#id_w').val()*scale);
						fd.append("h", $('#id_h').val()*scale);
						fd.append("original", data.data.id);
						//fd.append("filename", data.data.image);
					    var xhr = new XMLHttpRequest();
						xhr.addEventListener("load", avatarUploaded, false);
					    xhr.open("POST", "/cropper/"+ data.data.id +"/");
						xhr.setRequestHeader("X_REQUESTED_WITH", 'XMLHttpRequest');
						xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
					    xhr.send(fd);
						})
					
							
					}else {
						$('#errors-modal .modal-body ul').html("<li><h5>"+ data.errors.image[0] +"</h5></li>")
						$('#errors-modal').modal('show')
					}
				  }
			      function uploadFailed(evt) {
			        alert("There was an error attempting to upload the file.");
			      }

			      function uploadCanceled(evt) {
			        alert("The upload has been canceled by the user or the browser dropped the connection.");
			      }
				function getCookie(name) {
			        var cookieValue = null;
			        if (document.cookie && document.cookie != '') {
			            var cookies = document.cookie.split(';');
			            for (var i = 0; i < cookies.length; i++) {
			                var cookie = $.trim(cookies[i]);
			                // Does this cookie string begin with the name we want?
			                if (cookie.substring(0, name.length + 1) == (name + '=')) {
			                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
			                    break;
			                }
			            }
			        }
			        return cookieValue;
			    }
			  function showCoords(c)
			    {
			      $('#id_x').val(Math.floor(c.x));
			      $('#id_y').val(Math.floor(c.y));
			      $('#id_w').val(Math.floor(c.w));
			      $('#id_h').val(Math.floor(c.h));
			    };
				$.foo = function(){
					console.log("Width: " + $('.modal-body img').width() + " Height: " + $('.modal-body img').height())
					
				}
			    function clearCoords()
			    {
			      $('#coords input').val('');
			    };
			    function avatarUploaded(evt)
				{
					var data = $.parseJSON(evt.target.response)
					console.dir(data)
					$('#avatar').attr("src", data.data.image.url)
					$('#avatar').width(246)
					$('#avatar').height(284)
					$('#myModal').modal('hide')
					
					
				};
				function deleteImage(id_image){
					console.log('DeleteImage...')
				    var xhr = new XMLHttpRequest();
					xhr.addEventListener("load", deleteSuccess, false);
				    xhr.open("POST", "/ajax/image/delete/"+ id_image +"/");
					xhr.setRequestHeader("X_REQUESTED_WITH", 'XMLHttpRequest');
					xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
				    xhr.send();
				}
				function deleteSuccess(evt){
					console.log('DeleteSuccess')
				}
           })
    </script>
{% endblock %}